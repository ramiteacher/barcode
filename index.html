<!DOCTYPE html>
<html>
  <head>
    <title>ë„¤ì˜¨ ì¬ê³ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="sheet.js" defer></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h2>ğŸ“¦ ë„¤ì˜¨ ì¬ê³ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
    <div id="loginSection">
      <div id="g_id_onload"
           data-client_id="192783618509-d0ev6sp714cr4d43cfumfaum005g485t.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="true"></div>
      <div class="g_id_signin" data-type="standard"></div>
    </div>
    <div id="sheetSetup" style="display:none;">
      <p id="userInfo"></p>
      <input id="sheetName" placeholder="ì‹œíŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="createBtn">ì‹œíŠ¸ ìƒì„±</button>
    </div>
    <div id="errorMessage" style="color: red; display: none;"></div>

    <script>
      // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
      async function checkCameraPermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // ìŠ¤íŠ¸ë¦¼ ì‚¬ìš© í›„ í•´ì œ
          stream.getTracks().forEach(track => track.stop());
          return true;
        } catch (error) {
          console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œ ì˜¤ë¥˜:", error);
          document.getElementById("errorMessage").textContent = 
            "QR ìŠ¤ìºë„ˆë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: " + error.message;
          document.getElementById("errorMessage").style.display = "block";
          return false;
        }
      }

      // QR ìŠ¤ìºë„ˆ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
      async function navigateToQrScanner(sheetId) {
        // ê¶Œí•œ í™•ì¸ í›„ ì´ë™
        if (await checkCameraPermission()) {
          window.location.href = `qr.html?sheetId=${sheetId}`;
        }
      }

      window.onload = () => {
        const email = localStorage.getItem("userEmail");
        const cachedSheetId = localStorage.getItem("sheetId");
        
        if (email && cachedSheetId) {
          // QR ìŠ¤ìºë„ˆ í˜ì´ì§€ë¡œ ì´ë™ ì „ ìœ íš¨ì„± ê²€ì‚¬
          if (cachedSheetId.trim() === "") {
            document.getElementById("errorMessage").textContent = "ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œíŠ¸ IDì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
            document.getElementById("errorMessage").style.display = "block";
            localStorage.removeItem("sheetId");
            // ë¡œê·¸ì¸ ì„¹ì…˜ í‘œì‹œ
            document.getElementById("loginSection").style.display = "block";
          } else {
            navigateToQrScanner(cachedSheetId);
          }
        } else if (email) {
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("sheetSetup").style.display = "block";
          document.getElementById("userInfo").innerText = `${email}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
        }
      }
    </script>
  </body>
</html>