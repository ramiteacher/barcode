<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>QR ì¸ì‹ ì¬ê³  ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="style.css" />
  <!-- PWA ê´€ë ¨ ë©”íƒ€íƒœê·¸ ë° ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë§í¬ ì¶”ê°€ -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00f0ff" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    .top-button {
      background-color: #1e293b;
      color: #00f0ff;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      border: 1px solid #00f0ff;
      margin-left: 6px;
      cursor: pointer;
    }
    .top-button:hover {
      background-color: #00f0ff;
      color: #000;
    }
    
    /* ì„¤ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #installButton {
      background-color: #00f0ff;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px auto;
      display: block;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #installButton:hover {
      background-color: #00d6e0;
      transform: translateY(-2px);
      transition: all 0.2s;
    }

    /* ì•± ì„¤ì¹˜ ì•ˆë‚´ ë°°ë„ˆ */
    #installBanner {
      display: none;
      background-color: #1e293b;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 10px auto;
      max-width: 480px;
      border: 2px solid #00f0ff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .banner-title {
      font-weight: bold;
      color: #00f0ff;
      margin-bottom: 8px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .banner-close {
      position: absolute;
      right: 10px;
      top: 10px;
      background: none;
      border: none;
      color: #00f0ff;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; padding: 4px 8px; align-items: center;">
    <div id="sheetTitle" style="color: #00f0ff;">ğŸ“„ ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div>
      <button id="sheetButton" class="top-button">ì‹œíŠ¸</button>
      <button id="adminButton" class="top-button">ê´€ë¦¬ì</button>
    </div>
  </div>

  <!-- ì•± ì„¤ì¹˜ ì•ˆë‚´ ë°°ë„ˆ -->
  <div id="installBanner">
    <button class="banner-close" id="closeBanner">âœ•</button>
    <div class="banner-title">
      <span>ğŸ“±</span>
      <span>ì•± ì„¤ì¹˜ ì•ˆë‚´</span>
    </div>
    <p>ë” ë¹ ë¥´ê³  í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ë ¤ë©´ ì•±ì„ ì„¤ì¹˜í•´ë³´ì„¸ìš”!</p>
    <button id="installButton">ì•± ì„¤ì¹˜í•˜ê¸°</button>
  </div>

  <div id="reader" style="width: 100%; max-width: 480px; margin: auto;"></div>
  <input id="code" placeholder="ìƒí’ˆì½”ë“œ" readonly />
  <input id="name" placeholder="ìƒí’ˆëª…" />
  <input id="quantity" type="number" placeholder="ìˆ˜ëŸ‰" />
  <input id="user" placeholder="ë‹´ë‹¹ìëª…" />

  <div>
    <button class="action ì…ê³ " onclick="setAction('ì…ê³ ')">ì…ê³ </button>
    <button class="action ì¶œê³ " onclick="setAction('ì¶œê³ ')">ì¶œê³ </button>
    <button class="action ë°˜í’ˆ" onclick="setAction('ë°˜í’ˆ')">ë°˜í’ˆ</button>
    <button class="action í•˜ì" onclick="setAction('í•˜ì')">í•˜ì</button>
  </div>

  <p id="status"></p>
  <div id="summary"></div>

  <script src="qr.js"></script>
  <script src="qr-fixed.js"></script>
  <script>
    // COOP ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•œ ê°œì„ ëœ í•¨ìˆ˜
    async function getSheetAccessToken() {
      // ì´ë¯¸ ë¡œë“œëœ qr-fixed.jsì˜ getAccessToken í•¨ìˆ˜ ì‚¬ìš© ì‹œë„
      if (typeof getAccessToken === 'function') {
        return await getAccessToken();
      }
      
      // ë˜ëŠ” ì§ì ‘ êµ¬í˜„
      return new Promise((resolve) => {
        const cached = localStorage.getItem("accessToken");
        if (cached) {
          // ìºì‹œëœ í† í° ê²€ì¦
          fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=properties.title`, {
            headers: { Authorization: "Bearer " + cached }
          })
          .then(res => {
            if (res.ok) return resolve(cached);
            // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìš”ì²­
            localStorage.removeItem("accessToken");
            requestNewToken();
          })
          .catch(() => {
            localStorage.removeItem("accessToken");
            requestNewToken();
          });
        } else {
          requestNewToken();
        }
        
        function requestNewToken() {
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: "192783618509-d0ev6sp714cr4d43cfumfaum005g485t.apps.googleusercontent.com",
            scope: "https://www.googleapis.com/auth/spreadsheets", // ì „ì²´ ê¶Œí•œìœ¼ë¡œ í†µì¼
            callback: (res) => {
              if (res && res.access_token) {
                localStorage.setItem("accessToken", res.access_token);
                resolve(res.access_token);
              } else {
                resolve(null);
              }
            }
          });
          
          // ì´ì „ì— ë™ì˜í–ˆë‹¤ë©´ ì¡°ìš©íˆ ìš”ì²­
          tokenClient.requestAccessToken({prompt: ''});
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const sheetId = new URLSearchParams(location.search).get("sheetId");
      const sheetTitle = document.getElementById("sheetTitle");
      const sheetBtn = document.getElementById("sheetButton");
      const adminBtn = document.getElementById("adminButton");

      sheetBtn.onclick = () => {
        if (sheetId) {
          window.open(`https://docs.google.com/spreadsheets/d/${sheetId}`, "_blank");
        } else {
          alert("âŒ ì‹œíŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      };

      adminBtn.onclick = () => {
        if (sheetId) {
          window.location.href = `admin.html?sheetId=${sheetId}`;
        } else {
          alert("âŒ ì‹œíŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      };

      // OAuth ì¸ì¦ì„ ì‚¬ìš©í•˜ì—¬ ì‹œíŠ¸ ì œëª© ê°€ì ¸ì˜¤ê¸°
      if (sheetId) {
        try {
          const token = await getSheetAccessToken();
          
          if (!token) {
            sheetTitle.innerText = "ğŸ“„ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤";
            return;
          }
          
          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=properties.title`,
            { headers: { Authorization: `Bearer ${token}` } }
          );
          
          if (!response.ok) {
            throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
          }
          
          const data = await response.json();
          sheetTitle.innerText = `ğŸ“„ ì—°ê²°ëœ ì‹œíŠ¸: ${data.properties.title}`;
        } catch (error) {
          console.error("ì‹œíŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
          sheetTitle.innerText = "ğŸ“„ ì‹œíŠ¸ ì ‘ê·¼ ì˜¤ë¥˜ ë°œìƒ";
        }
      }
    });

    // PWA ì„¤ì¹˜ ê´€ë ¨ ì½”ë“œ
    let deferredPrompt;
    const installButton = document.getElementById('installButton');
    const installBanner = document.getElementById('installBanner');
    const closeBanner = document.getElementById('closeBanner');

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', reg.scope))
          .catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', err));
      });
    }

    // ì´ì „ì— ë°°ë„ˆë¥¼ ë‹«ì•˜ëŠ”ì§€ í™•ì¸
    function hasUserDismissedInstall() {
      return localStorage.getItem('installBannerDismissed') === 'true';
    }

    // ë°°ë„ˆ ë‹«ê¸° ì´ë²¤íŠ¸
    closeBanner.addEventListener('click', () => {
      installBanner.style.display = 'none';
      localStorage.setItem('installBannerDismissed', 'true');
    });

    // ì•± ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
    window.addEventListener('beforeinstallprompt', (e) => {
      // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ë°©ì§€
      e.preventDefault();
      // ì´ë²¤íŠ¸ ì €ì¥
      deferredPrompt = e;
      
      // ì‚¬ìš©ìê°€ ì´ì „ì— ë‹«ì§€ ì•Šì•˜ë‹¤ë©´ ë°°ë„ˆ í‘œì‹œ
      if (!hasUserDismissedInstall()) {
        installBanner.style.display = 'block';
      }
    });

    // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        deferredPrompt.prompt();
        // ì‚¬ìš©ì ì‘ë‹µ ëŒ€ê¸°
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`ì‚¬ìš©ì ì„ íƒ: ${outcome}`);
        // ì´ë²¤íŠ¸ ì°¸ì¡° ì •ë¦¬
        deferredPrompt = null;
        // ì„¤ì¹˜ ë°°ë„ˆ ìˆ¨ê¸°ê¸°
        installBanner.style.display = 'none';
      }
    });

    // ì•±ì´ ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš°
    window.addEventListener('appinstalled', () => {
      console.log('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
      installBanner.style.display = 'none';
      localStorage.setItem('appInstalled', 'true');
    });

    // ì´ë¯¸ ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ìŠ¤íƒ ë“œì–¼ë¡  ëª¨ë“œ í™•ì¸)
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
      console.log('ì•±ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
      localStorage.setItem('appInstalled', 'true');
    } else if (localStorage.getItem('appInstalled') !== 'true' && 
              !hasUserDismissedInstall()) {
      // ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê³  ì‚¬ìš©ìê°€ ë°°ë„ˆë¥¼ ë‹«ì§€ ì•Šì€ ê²½ìš°
      // beforeinstallprompt ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ë°°ë„ˆê°€ í‘œì‹œë¨
      console.log('ì•± ì„¤ì¹˜ ì¤€ë¹„ - í”„ë¡¬í”„íŠ¸ ëŒ€ê¸° ì¤‘');
    }
  </script>
</body>
</html>
